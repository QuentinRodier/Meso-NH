!MNH_LIC Copyright 2016 CNRS, Meteo-France and Universite Paul Sabatier
!MNH_LIC This is part of the Meso-NH software governed by the CeCILL-C licence
!MNH_LIC version 1. See LICENSE, CeCILL-C_V1-en.txt and CeCILL-C_V1-fr.txt  
!MNH_LIC for details. version 1.
MODULE MODE_FIELD
!
USE MODD_PARAMETERS
!
IMPLICIT NONE
!
INTEGER,PRIVATE,PARAMETER :: MAXFIELDS = 9
INTEGER,PARAMETER :: TYPEUNDEF = -1, TYPEINT = 1, TYPELOG = 2, TYPEREAL = 3, TYPECHAR = 4
!
TYPE TFIELDPTR_X2D
  REAL,DIMENSION(:,:),  POINTER :: DATA => NULL()
END TYPE TFIELDPTR_X2D
!
TYPE TFIELDPTR_X3D
  REAL,DIMENSION(:,:,:),POINTER :: DATA => NULL()
END TYPE TFIELDPTR_X3D
!
!Structure describing the characteristics of a field
TYPE TFIELDDATA
  CHARACTER(LEN=NMNHNAMELGTMAX) :: CMNHNAME  = '' !Name of the field (for MesoNH, non CF convention)
  CHARACTER(LEN=32)  :: CSTDNAME  = '' !Standard name (CF convention)
  CHARACTER(LEN=32)  :: CLONGNAME = '' !Long name (CF convention)
  CHARACTER(LEN=32)  :: CUNITS    = '' !Canonical units (CF convention)
  CHARACTER(LEN=2)   :: CDIR      = '' !Type of the data field (XX,XY,--...)
  CHARACTER(LEN=100) :: CCOMMENT  = '' !Comment (for MesoNH, non CF convention)
  INTEGER            :: NGRID     = -1 !Localization on the model grid
  INTEGER            :: NTYPE     = TYPEUNDEF !Datatype
  INTEGER            :: NDIMS     = 0  !Number of dimensions
  TYPE(TFIELDPTR_X2D),DIMENSION(:),ALLOCATABLE :: TFIELD_X2D !Pointer to the real 2D fields (one per nested mesh)
  TYPE(TFIELDPTR_X3D),DIMENSION(:),ALLOCATABLE :: TFIELD_X3D !Pointer to the real 3D fields (one per nested mesh)
END TYPE TFIELDDATA
!
LOGICAL,SAVE :: LFIELDLIST_ISINIT = .FALSE.
TYPE(TFIELDDATA),DIMENSION(MAXFIELDS),SAVE :: TFIELDLIST
!
CONTAINS
!
SUBROUTINE INI_FIELD_LIST()
!
USE MODD_CONF, ONLY: NMODEL
!
INTEGER :: IDX
!
!F90/95: TFIELDLIST(1) = TFIELDDATA('UT','x_wind','m s-1','XY','X_Y_Z_U component of wind (m/s)',2)
!F2003:
!TFIELDLIST(1) = TFIELDDATA(CMNHNAME='UT',CSTDNAME='x_wind',CUNITS='m s-1',CDIR='XY',&
!                           CCOMMENT='X_Y_Z_U component of wind (m/s)',NGRID=2)
!
PRINT *,'PW: INI_FIELD_LIST called'
IF (LFIELDLIST_ISINIT) THEN
  PRINT *,'ERROR: INI_FIELD_LIST already called'
  RETURN
END IF
LFIELDLIST_ISINIT = .TRUE.
!
IDX = 1
!
TFIELDLIST(IDX)%CMNHNAME   = 'MASDEV'
TFIELDLIST(IDX)%CSTDNAME   = ''
TFIELDLIST(IDX)%CLONGNAME  = 'MesoNH version (without bugfix)'
TFIELDLIST(IDX)%CUNITS     = ''
TFIELDLIST(IDX)%CDIR       = '--'
TFIELDLIST(IDX)%CCOMMENT   = ''
TFIELDLIST(IDX)%NGRID      = 0
TFIELDLIST(IDX)%NTYPE      = TYPEINT
TFIELDLIST(IDX)%NDIMS      = 0
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'BUGFIX'
TFIELDLIST(IDX)%CSTDNAME   = ''
TFIELDLIST(IDX)%CLONGNAME  = 'MesoNH bugfix number'
TFIELDLIST(IDX)%CUNITS     = ''
TFIELDLIST(IDX)%CDIR       = ''
TFIELDLIST(IDX)%CCOMMENT   = ''
TFIELDLIST(IDX)%NGRID      = 0
TFIELDLIST(IDX)%NTYPE      = TYPEINT
TFIELDLIST(IDX)%NDIMS      = 0
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'BIBUSER'
TFIELDLIST(IDX)%CSTDNAME   = ''
TFIELDLIST(IDX)%CLONGNAME  = 'MesoNH: user binary library'
TFIELDLIST(IDX)%CUNITS     = ''
TFIELDLIST(IDX)%CDIR       = ''
TFIELDLIST(IDX)%CCOMMENT   = ''
TFIELDLIST(IDX)%NGRID      = 0
TFIELDLIST(IDX)%NTYPE      = TYPECHAR
TFIELDLIST(IDX)%NDIMS      = 0
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'PROGRAM'
TFIELDLIST(IDX)%CSTDNAME   = ''
TFIELDLIST(IDX)%CLONGNAME  = 'MesoNH family: used program'
TFIELDLIST(IDX)%CUNITS     = ''
TFIELDLIST(IDX)%CDIR       = ''
TFIELDLIST(IDX)%CCOMMENT   = ''
TFIELDLIST(IDX)%NGRID      = 0
TFIELDLIST(IDX)%NTYPE      = TYPECHAR
TFIELDLIST(IDX)%NDIMS      = 0
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'FILETYPE'
TFIELDLIST(IDX)%CSTDNAME   = ''
TFIELDLIST(IDX)%CLONGNAME  = 'Type of this file for MesoNH'
TFIELDLIST(IDX)%CUNITS     = ''
TFIELDLIST(IDX)%CDIR       = ''
TFIELDLIST(IDX)%CCOMMENT   = ''
TFIELDLIST(IDX)%NGRID      = 0
TFIELDLIST(IDX)%NTYPE      = TYPECHAR
TFIELDLIST(IDX)%NDIMS      = 0
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'UT'
TFIELDLIST(IDX)%CSTDNAME   = 'x_wind'
TFIELDLIST(IDX)%CLONGNAME  = ''
TFIELDLIST(IDX)%CUNITS     = 'm s-1'
TFIELDLIST(IDX)%CDIR       = 'XY'
TFIELDLIST(IDX)%CCOMMENT   = 'X_Y_Z_U component of wind (m/s)'
TFIELDLIST(IDX)%NGRID      = 2
TFIELDLIST(IDX)%NTYPE      = TYPEREAL
TFIELDLIST(IDX)%NDIMS      = 3
ALLOCATE(TFIELDLIST(IDX)%TFIELD_X3D(NMODEL))
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'VT'
TFIELDLIST(IDX)%CSTDNAME   = 'y_wind'
TFIELDLIST(IDX)%CLONGNAME  = ''
TFIELDLIST(IDX)%CUNITS     = 'm s-1'
TFIELDLIST(IDX)%CDIR       = 'XY'
TFIELDLIST(IDX)%CCOMMENT   = 'X_Y_Z_V component of wind (m/s)'
TFIELDLIST(IDX)%NGRID      = 3
TFIELDLIST(IDX)%NTYPE      = TYPEREAL
TFIELDLIST(IDX)%NDIMS      = 3
ALLOCATE(TFIELDLIST(IDX)%TFIELD_X3D(NMODEL))
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'THT'
TFIELDLIST(IDX)%CSTDNAME   = 'air_potential_temperature'
TFIELDLIST(IDX)%CLONGNAME  = ''
TFIELDLIST(IDX)%CUNITS     = 'K'
TFIELDLIST(IDX)%CDIR       = 'XY'
TFIELDLIST(IDX)%CCOMMENT   = 'X_Y_Z_potential temperature (K)'
TFIELDLIST(IDX)%NGRID      = 1
TFIELDLIST(IDX)%NTYPE      = TYPEREAL
TFIELDLIST(IDX)%NDIMS      = 3
ALLOCATE(TFIELDLIST(IDX)%TFIELD_X3D(NMODEL))
IDX = IDX+1
!
TFIELDLIST(IDX)%CMNHNAME   = 'ACPRR'
TFIELDLIST(IDX)%CSTDNAME   = 'rainfall_amount'
TFIELDLIST(IDX)%CLONGNAME  = ''
!PW: TODO: CF-convention prefers 'kg m-2'
TFIELDLIST(IDX)%CUNITS     = 'm'
TFIELDLIST(IDX)%CDIR       = ''
TFIELDLIST(IDX)%CCOMMENT   = 'X_Y_ACcumulated Precipitation Rain Rate (m)'
TFIELDLIST(IDX)%NGRID      = 1
TFIELDLIST(IDX)%NTYPE      = TYPEREAL
TFIELDLIST(IDX)%NDIMS      = 2
ALLOCATE(TFIELDLIST(IDX)%TFIELD_X2D(NMODEL))
IDX = IDX+1
!
#if 0
!
TFIELDLIST(IDX)%CMNHNAME   = ''
TFIELDLIST(IDX)%CSTDNAME   = ''
TFIELDLIST(IDX)%CLONGNAME  = ''
TFIELDLIST(IDX)%CUNITS     = ''
TFIELDLIST(IDX)%CDIR       = ''
TFIELDLIST(IDX)%CCOMMENT   = ''
TFIELDLIST(IDX)%NGRID      = 
TFIELDLIST(IDX)%NTYPE      = 
TFIELDLIST(IDX)%NDIMS      = 
ALLOCATE(TFIELDLIST(IDX)%TFIELD_xxxD(NMODEL))
IDX = IDX+1
#endif

END SUBROUTINE INI_FIELD_LIST
!
SUBROUTINE FIND_FIELD_ID_FROM_MNHNAME(HMNHNAME,KID,KRESP)
!
CHARACTER(LEN=*),            INTENT(IN) :: HMNHNAME !Name of the field to find
INTEGER,                     INTENT(OUT):: KID      !Index of the field
INTEGER,                     INTENT(OUT):: KRESP    !Return-code 
!
INTEGER :: JI
!
!PW: TODO: to optimize
!Ideas :
! * Classement alphanumerique + index vers 1er champ commencant par caractere
! * Classement dans l'ordre des ecritures + stockage dernier hit + reboucler depuis le debut
!
IF (.NOT.LFIELDLIST_ISINIT) THEN
  PRINT *,'FATAL: FIND_FIELD_ID_FROM_MNHNAME: TFIELDLIST not yet initialized'
  STOP
END IF
!
KID = 0
KRESP = 0
!
DO JI = 1,MAXFIELDS
  IF (TRIM(TFIELDLIST(JI)%CMNHNAME)==TRIM(HMNHNAME)) THEN
    KID = JI
    EXIT
  END IF
END DO
!
IF (KID==0) THEN
  !Field not found
  KRESP = -1
  PRINT *,'WARNING: FIND_FIELD_ID_FROM_MNHNAME: field ',TRIM(HMNHNAME),' not known'
END IF
!
END SUBROUTINE FIND_FIELD_ID_FROM_MNHNAME
!
END MODULE MODE_FIELD
